{% extends "base.html" %}
{% block content %}
<h3 class="mb-3">Students</h3>
<div class="row g-4">
  <div class="col-lg-5">
    <div class="card h-100">
      <div class="card-header bg-white fw-semibold">Registered Students</div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead><tr><th scope="col">Name</th><th scope="col" class="text-end">Samples</th></tr></thead>
            <tbody>
              {% for s in students %}
                <tr><td>{{ s.name }}</td><td class="text-end"><span class="badge bg-primary">{{ s.samples }}</span></td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  <div class="col-lg-7">
    <div class="card mb-4">
      <div class="card-header bg-white fw-semibold">Register by Upload</div>
      <div class="card-body">
        <form id="uploadForm" class="row g-3" method="post" action="/api/register" enctype="multipart/form-data">
          <div class="col-12">
            <label class="form-label" for="nameUpload">Name</label>
            <input class="form-control" id="nameUpload" name="name" required aria-required="true">
          </div>
          <div class="col-12">
            <label class="form-label" for="imagesUpload">Images</label>
            <input class="form-control" id="imagesUpload" name="images" type="file" multiple accept="image/*" required aria-required="true">
          </div>
          <div class="col-12 d-flex align-items-center gap-2">
            <button class="btn btn-primary" type="submit"><i class="bi bi-person-plus"></i> Register</button>
            <span id="uploadMsg" class="ms-2 text-muted" role="status" aria-live="polite"></span>
          </div>
        </form>
      </div>
    </div>
    <div class="card">
      <div class="card-header bg-white fw-semibold">Register by Webcam</div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-12">
            <label class="form-label" for="camName">Name</label>
            <input class="form-control" id="camName" aria-label="Name for webcam registration">
          </div>
          <div class="col-12">
            <div class="video-box">
              <video id="cam" autoplay playsinline class="w-100" style="max-height:300px"></video>
            </div>
          </div>
          <div class="col-12 d-flex gap-2">
            <button class="btn btn-outline-secondary" id="startBtn" type="button"><i class="bi bi-camera-video"></i> Start Camera</button>
            <button class="btn btn-primary" id="sendBtn" type="button"><i class="bi bi-cloud-upload"></i> Capture & Send (10 frames)</button>
            <span id="msg" class="toast-like" role="status" aria-live="polite"></span>
          </div>
        </div>
        <canvas id="canvas" class="d-none"></canvas>
      </div>
    </div>
  </div>
</div>
<div class="card mt-4">
  <div class="card-body">
    <h5 class="card-title">Remove Students</h5>
    <form method="post" action="/students/remove">
      <div class="mb-3">
        <label class="form-label" for="removeNames">Names to Remove</label>
        <input type="text" id="removeNames" name="names" class="form-control" placeholder="Comma separated (case-insensitive), e.g. yash mishra, John">
        <div class="form-text">Removal is case-insensitive and ignores extra spaces. Example: "  yAsH   mIshra " matches "Yash Mishra".</div>
      </div>
      <button class="btn btn-danger w-100" type="submit"><i class="bi bi-trash"></i> Remove</button>
    </form>
  </div>
</div>
<script>
  const uploadForm = document.getElementById('uploadForm');
  uploadForm.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const fd = new FormData(uploadForm);
    const res = await fetch('/api/register', { method:'POST', body: fd });
    const js = await res.json();
    document.getElementById('uploadMsg').textContent = res.ok ? `Added ${js.added_samples} samples (total ${js.total_samples_for_name})` : (js.error||'Error');
  });

  const cam = document.getElementById('cam');
  const canvas = document.getElementById('canvas');
  const msg = document.getElementById('msg');
  document.getElementById('startBtn').onclick = async () => {
    const s = await navigator.mediaDevices.getUserMedia({ video: true });
    cam.srcObject = s;
  };
  document.getElementById('sendBtn').onclick = async () => {
    const name = document.getElementById('camName').value.trim();
    if(!name){ msg.textContent = 'Enter name first'; return; }
    const frames = [];
    const ctx = canvas.getContext('2d');
    canvas.width = cam.videoWidth; canvas.height = cam.videoHeight;
    for(let i=0;i<10;i++){
      ctx.drawImage(cam,0,0);
      const b64 = canvas.toDataURL('image/jpeg', 0.9);
      frames.push(b64);
      await new Promise(r=>setTimeout(r,200));
    }
    const res = await fetch('/api/register-webcam', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({name, frames})});
    const js = await res.json();
    msg.textContent = res.ok ? `Added ${js.added_samples} samples (total ${js.total_samples_for_name})` : (js.error||'Error');
  };
</script>
{% endblock %}
